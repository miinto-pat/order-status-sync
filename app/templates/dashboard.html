<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Miinto Affiliate Order Automation Dashboard</a>
        <div class="d-flex">
            <span class="navbar-text me-3 text-white">{{ current_user.id }}</span>
            <a class="btn btn-outline-light" href="{{ url_for('bp.logout') }}">Logout</a>
        </div>
    </div>
</nav>


<div class="container mt-5">
    <h3></h3>
    <p class="text-muted">
    This bot automates order status updates between Impact and Miinto Admin to ensure accurate, VAT-excluded commission reporting.
</p>
    <form id="runBotForm">
        <div class="row mb-3">
        <div class="mb-3">
    <label class="form-label fw-bold">Select Markets</label>
    <div class="d-flex flex-wrap gap-2">
        {% for campaign_id, code in markets.items() %}
            <div class="form-check form-check-inline m-0">
                <input class="form-check-input" type="checkbox"
                       name="markets"
                       value="{{ campaign_id }}"
                       id="market_{{ code }}">
                <label class="form-check-label small" for="market_{{ code }}">
                    {{ code }}
                </label>
            </div>
        {% endfor %}
    </div>
</div>

        <div class="col">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" id="startDate" name="start_date" class="form-control">
        </div>
        <div class="col">
            <label for="endDate" class="form-label">End Date</label>
            <input type="date" id="endDate" name="end_date" class="form-control">
        </div>
    </div>
    <button type="submit" id="runBotBtn" class="btn btn-success mb-3">Run Bot</button>
</form>


<div id="progressMessage" class="alert alert-info mt-2">Bot is idle. Please choose a start and end date, then click “Run Bot”.</div>
    <div id="marketStats" class="mt-3">
          <button id="downloadZipBtn" class="btn btn-primary mt-3 d-none">
    ⬇️ Download all results
</button>

    </div>


    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="alert alert-info">
            {% for msg in messages %}{{ msg }}<br>{% endfor %}
        </div>
    {% endif %}
    {% endwith %}
<script>
    const CAMPAIGN_TO_MARKET = {{ markets | tojson }};
</script>

<script>
document.getElementById("runBotForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const btn = document.getElementById("runBotBtn");
    const msgDiv = document.getElementById("progressMessage");
    const statsDiv = document.getElementById("marketStats");

    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    const selectedMarkets = Array.from(document.querySelectorAll("input[name='markets']:checked"))
                                .map(cb => cb.value);

    // Validate inputs
    let missingFields = [];
    if (!startDate) missingFields.push("start date");
    if (!endDate) missingFields.push("end date");
    if (selectedMarkets.length === 0) missingFields.push("at least one market");

    if (missingFields.length > 0) {
        msgDiv.className = "alert alert-danger mt-2";
        msgDiv.innerText = "Please select " + missingFields.join(", ") + ".";
        btn.disabled = false;
        return;
    }

    if (new Date(endDate) < new Date(startDate)) {
        msgDiv.className = "alert alert-danger mt-2";
        msgDiv.innerText = "End date must be after the start date.";
        btn.disabled = false;
        return;
    }

    const MAX_MARKETS = 50;
    if (selectedMarkets.length > MAX_MARKETS) {
        msgDiv.className = "alert alert-warning mt-2";
        msgDiv.innerText = `You can select up to ${MAX_MARKETS} markets at a time.`;
        btn.disabled = false;
        return;
    }

    // Initialize table if not exists
    if (!document.getElementById("liveResultsTable")) {
        statsDiv.innerHTML = `
        <table id="liveResultsTable" class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Market</th>
                    <th>Total</th>
                    <th>VOUCHER/Rejections</th>
                    <th>FULLY_RETURNED</th>
                    <th>ORDER_UPDATE</th>
                    <th>Not Modified</th>
                    <th>Not Processed</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody id="marketRows"></tbody>
        </table>
        <div id="errorSummary" class="mt-3"></div>
        <button id="downloadZipBtn" class="btn btn-primary mt-3 d-none">⬇️ Download all results</button>
        `;
    }

    const tbody = document.getElementById("marketRows");
    const selectedMarketNames = selectedMarkets.map(id => CAMPAIGN_TO_MARKET[id]).filter(Boolean);

    const marketsToRun = selectedMarketNames;

    if (marketsToRun.length === 0) {
        msgDiv.innerText = "No markets selected.";
        btn.disabled = false;
        return;
    }

<!--    const oldMarkets = Array.from(tbody.querySelectorAll("tr"))-->
<!--                            .map(row => row.getAttribute("data-market"));-->

<!--    // Map selected checkboxes to market names-->


<!--    let marketsToRun = [];-->
<!--    const hasOverlap = selectedMarketNames.some(m => oldMarkets.includes(m));-->

<!--    if (!hasOverlap) {-->
<!--        // Completely new selection, clear table-->
<!--        tbody.innerHTML = "";-->
<!--        marketsToRun = selectedMarketNames;-->
<!--    } else {-->
<!--        // Some overlap – only run newly selected markets not already in table-->
<!--        marketsToRun = selectedMarketNames.filter(m => !oldMarkets.includes(m));-->
<!--    }-->

<!--    if (marketsToRun.length === 0) {-->
<!--        msgDiv.className = "alert alert-info mt-2";-->
<!--        msgDiv.innerText = "All selected markets have already been processed.";-->
<!--        btn.disabled = false;-->
<!--        return;-->
<!--    }-->

    // Reset UI
    msgDiv.className = "alert alert-info mt-2";
    msgDiv.innerText = "Starting bot...";
    btn.disabled = true;
    document.getElementById("downloadZipBtn").classList.add("d-none");

    if (window.botInterval) clearInterval(window.botInterval);

    // Start bot
    fetch("{{ url_for('bp.run_bot') }}", {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ start_date: startDate, end_date: endDate, markets: marketsToRun })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.status === "error") {
            msgDiv.className = "alert alert-danger mt-2";
            msgDiv.innerText = data.message || "Error while retrieving actions";
            btn.disabled = false;
            return;
        }
        currentRunId = data.run_id;
        msgDiv.innerText = data.message || "Bot started...";
        window.botInterval = startPolling();
    })
    .catch(err => {
        msgDiv.className = "alert alert-danger mt-2";
        msgDiv.innerText = err.message || "Error starting bot.";
        btn.disabled = false;
        console.error(err);
    });

    function startPolling() {
        return setInterval(() => {
            fetch("{{ url_for('bp.bot_status_endpoint') }}")
                .then(resp => resp.json())
                .then(status => {
                    if (status.run_id !== currentRunId) return;
                    if (status.status === "running") {
                        msgDiv.className = "alert alert-info mt-2";
                        msgDiv.innerText = status.message || "Processing...";
                    } else if (msgDiv.innerText !== status.message) {
                        msgDiv.innerText = status.message || "Running...";
                    }

                    if (status.market_stats) {
                        for (const [market, s] of Object.entries(status.market_stats)) {
                            let row = tbody.querySelector(`tr[data-market="${market}"]`);
                            if (!row) {
                                row = document.createElement("tr");
                                row.setAttribute("data-market", market);
                                tbody.appendChild(row);
                            }

<!--                            const isProcessing = status.message && status.message.includes(market) && !s.error;-->
                            const isProcessing = status.current_market === market;

                            row.className = isProcessing ? "table-warning" : "";

                            row.innerHTML = `
                                <td>${market}${isProcessing ? " ⏳ Processing..." : ""}</td>
                                <td>${s.total_actions ?? 0}</td>
                                <td>${s.OTHER ?? 0}</td>
                                <td>${s.ITEM_RETURNED ?? 0}</td>
                                <td>${s.ORDER_UPDATE ?? 0}</td>
                                <td>${s.Not_Modified ?? 0}</td>
                                <td>${s.Not_Processed ?? 0}</td>
                                <td>${s.error ?? ""}</td>
                            `;
                        }
                    }

                    if (status.status === "finished" && status.zip_blob_name) {
                        document.getElementById("downloadZipBtn").classList.remove("d-none");
                        btn.disabled = false;
                        msgDiv.className = "alert alert-success mt-2";
                        clearInterval(window.botInterval);
                    }

                    if (status.status === "error") {
                        btn.disabled = false;
                        msgDiv.className = "alert alert-danger mt-2";
                        clearInterval(window.botInterval);
                    }
                })
                .catch(err => {
                    console.error("Polling error:", err);
                    clearInterval(window.botInterval);
                    btn.disabled = false;
                });
        }, 1000);
    }
});

// Download button listener
document.addEventListener("click", function (e) {
    if (e.target && e.target.id === "downloadZipBtn") {
        fetch("/get-zip-url")
            .then(resp => resp.json())
            .then(data => {
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert("ZIP not ready yet!");
                }
            })
            .catch(err => {
                console.error("Error fetching ZIP URL:", err);
                alert("Failed to get ZIP URL.");
            });
    }
});
</script>




</div>
</body>
</html>
