<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Miinto Affiliate Order Automation Dashboard</a>
        <div class="d-flex">
            <span class="navbar-text me-3 text-white">{{ current_user.id }}</span>
            <a class="btn btn-outline-light" href="{{ url_for('bp.logout') }}">Logout</a>
        </div>
    </div>
</nav>


<div class="container mt-5">
    <h3></h3>
    <p class="text-muted">
    This bot automates order status updates between Impact and Miinto Admin to ensure accurate, VAT-excluded commission reporting.
</p>
    <form id="runBotForm">
        <div class="row mb-3">
        <div class="col">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" id="startDate" name="start_date" class="form-control">
        </div>
        <div class="col">
            <label for="endDate" class="form-label">End Date</label>
            <input type="date" id="endDate" name="end_date" class="form-control">
        </div>
    </div>
    <button type="submit" id="runBotBtn" class="btn btn-success mb-3">Run Bot</button>
</form>

<div id="progressMessage" class="alert alert-info mt-2">Bot is idle. Please choose a start and end date, then click “Run Bot”.</div>
    <div id="marketStats" class="mt-3"></div>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="alert alert-info">
            {% for msg in messages %}{{ msg }}<br>{% endfor %}
        </div>
    {% endif %}
    {% endwith %}
<script>
document.getElementById("runBotForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const btn = document.getElementById("runBotBtn");
    const msgDiv = document.getElementById("progressMessage");
    const statsDiv = document.getElementById("marketStats");

    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    // Validate dates
    if (!startDate || !endDate) {
        msgDiv.className = "alert alert-warning mt-2";
        msgDiv.innerText = "Please select both start and end dates.";
        return;
    }

    if (new Date(endDate) < new Date(startDate)) {
        msgDiv.className = "alert alert-danger mt-2";
        msgDiv.innerText = "End date must be after the start date.";
        return;
    }

    // Reset UI
    msgDiv.className = "alert alert-info mt-2";
    msgDiv.innerText = "Starting bot...";
    statsDiv.innerHTML = "";
    btn.disabled = true;

    // Start bot
    fetch("{{ url_for('bp.run_bot') }}", {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ start_date: startDate, end_date: endDate })
    })
    .then(resp => {
        if (!resp.ok) {
            // HTTP error -> show friendly message
            throw new Error("Error while retrieving actions");
        }
        return resp.json();
    })
    .then(data => {
        if (data.status === "error") {
            // Backend returned an error
            msgDiv.className = "alert alert-danger mt-2";
            msgDiv.innerText = "Error while retrieving actions";
            btn.disabled = false;
            return; // Stop further processing
        }

        msgDiv.className = "alert alert-info mt-2";
        msgDiv.innerText = data.message;

        // Start polling for bot status
        startPolling();
    })
    .catch(err => {
        msgDiv.className = "alert alert-danger mt-2";
        msgDiv.innerText = err.message || "Error starting bot.";
        btn.disabled = false;
        console.error(err);
    });

    // Polling function separated
    function startPolling() {
        const interval = setInterval(() => {
            fetch("{{ url_for('bp.bot_status_endpoint') }}")
                .then(resp => resp.json())
                .then(status => {
                    msgDiv.innerText = status.message;

                    // Show live stats (without table)
                    if (status.market_stats) {
                        let html = "";
                        for (const [market, s] of Object.entries(status.market_stats)) {
                            html += `<div>
                                <strong>${market}</strong>: Processed ${s.processed || 0} / ${s.total_actions || 0},
                                OTHER: ${s.OTHER || 0}, ITEM_RETURNED: ${s.ITEM_RETURNED || 0},
                                ORDER_UPDATE: ${s.ORDER_UPDATE || 0}, Not Modified: ${s.Not_Modified || 0}, Not Processed: ${s.Not_Processed || 0}
                            </div>`;
                        }
                        statsDiv.innerHTML = html;
                    }

                    // When finished successfully -> render table
                    if (status.status === "finished") {
                        renderTable(status.market_stats);
                        btn.disabled = false;
                        clearInterval(interval);
                    }

                    // Stop polling on error
                    if (status.status === "error") {
                        btn.disabled = false;
                        clearInterval(interval);
                    }
                })
                .catch(err => {
                    console.error("Polling error:", err);
                    btn.disabled = false;
                    clearInterval(interval);
                });
        }, 1000);
    }

    // Function to render table only on successful completion
    function renderTable(marketStats) {
        if (!marketStats) return;

        let html = "<table class='table table-sm table-bordered'>";
        html += "<thead><tr><th>Market</th><th>Total</th><th>VOUCHER/Rejections</th><th>FULLY_RETURNED</th><th>ORDER_UPDATE</th><th>Not Modified</th><th>Not Processed</th></tr></thead><tbody>";

        for (const [market, s] of Object.entries(marketStats)) {
            html += `<tr>
                <td>${market}</td>
                <td>${s.total_actions || 0}</td>
                <td>${s.OTHER || 0}</td>
                <td>${s.ITEM_RETURNED || 0}</td>
                <td>${s.ORDER_UPDATE || 0}</td>
                <td>${s.Not_Modified || 0}</td>
                <td>${s.Not_Processed || 0}</td>
            </tr>`;
        }

        html += "</tbody></table>";
        statsDiv.innerHTML = html;
    }
});


</script>



</div>
</body>
</html>
