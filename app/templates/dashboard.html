<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Bot Dashboard</a>
        <div class="d-flex">
            <span class="navbar-text me-3 text-white">{{ current_user.id }}</span>
            <a class="btn btn-outline-light" href="{{ url_for('bp.logout') }}">Logout</a>
        </div>
    </div>
</nav>


<div class="container mt-5">
    <h3>Run Bot</h3>
    <form id="runBotForm">
        <div class="row mb-3">
        <div class="col">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" id="startDate" name="start_date" class="form-control">
        </div>
        <div class="col">
            <label for="endDate" class="form-label">End Date</label>
            <input type="date" id="endDate" name="end_date" class="form-control">
        </div>
    </div>
    <button type="submit" id="runBotBtn" class="btn btn-success mb-3">Run Bot</button>
</form>
<!-- Status message under button -->
<div id="progressMessage" class="alert alert-info mt-2">Idle</div>
    <div id="marketStats" class="mt-3"></div>




    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="alert alert-info">
            {% for msg in messages %}{{ msg }}<br>{% endfor %}
        </div>
    {% endif %}
    {% endwith %}
<script>
document.getElementById("runBotForm").addEventListener("submit", function(e) {
    e.preventDefault(); // prevent page reload

    const btn = document.getElementById("runBotBtn");
    const msgDiv = document.getElementById("progressMessage");
    const statsDiv = document.getElementById("marketStats");

    btn.disabled = true;
    msgDiv.innerText = "Starting bot...";
    statsDiv.innerHTML = "";

    // Start the bot
    fetch("{{ url_for('bp.run_bot') }}", {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            start_date: document.getElementById("startDate").value,
            end_date: document.getElementById("endDate").value
        })
    })
    .then(resp => resp.json())
    .then(data => {
        msgDiv.innerText = data.message;

        const interval = setInterval(() => {
    fetch("{{ url_for('bp.bot_status_endpoint') }}")
        .then(resp => resp.json())
        .then(status => {
            msgDiv.innerText = status.message;

            // Show stats live, but without table headers
if (status.market_stats) {
    let html = "";
    for (const [market, s] of Object.entries(status.market_stats)) {
        html += `<div>
            <strong>${market}</strong>: Processed ${s.processed} / ${s.total_actions},
            OTHER: ${s.OTHER}, ITEM_RETURNED: ${s.ITEM_RETURNED},
            ORDER_UPDATE: ${s.ORDER_UPDATE}, Not Modified: ${s.Not_Modified}
        </div>`;
    }
    statsDiv.innerHTML = html;
}

// When finished or error, show full table with headers
if (status.status === "finished" || status.status === "error") {
    let html = "<table class='table table-sm table-bordered'>";
    html += "<thead><tr><th>Market</th><th>Total</th><th>VOUCHER/Rejections</th><th>FULLY_RETURNED</th><th>ORDER_UPDATE</th><th>Not Modified</th></tr></thead><tbody>";

    for (const [market, s] of Object.entries(status.market_stats)) {
        html += `<tr>
            <td>${market}</td>
            <td>${s.total_actions}</td>
            <td>${s.OTHER}</td>
            <td>${s.ITEM_RETURNED}</td>
            <td>${s.ORDER_UPDATE}</td>
            <td>${s.Not_Modified}</td>
        </tr>`;
    }

    html += "</tbody></table>";
    statsDiv.innerHTML = html;

    btn.disabled = false;
    clearInterval(interval);
}

        });
}, 1000);

    })
    .catch(err => {
        msgDiv.innerText = "Error starting bot.";
        btn.disabled = false;
        console.error(err);
    });
});
</script>



</div>
</body>
</html>
